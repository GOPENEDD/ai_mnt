<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>智能人流监测系统</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="format-detection" content="telephone=no">
    <meta charset="UTF-8">

    <meta name="description" content="Violate Responsive Admin Template">
    <meta name="keywords" content="Super Admin, Admin, Template, Bootstrap">

    <title>云监测平台</title>
    <!-- CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/bootstrap-table.min.css">
    <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.14.2/dist/bootstrap-table.min.css">
    <link href="css/animate.min.css" rel="stylesheet">
    <link href="css/font-awesome.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <link href="css/icons.css" rel="stylesheet">
    <link href="css/generics.css" rel="stylesheet">
    <link rel="stylesheet" href="css/form.css">
    <link rel="stylesheet" href="css/video-js.min.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap-select.css" />
    <link rel="stylesheet" href="laydate/theme/default/laydate.css" >
    <!--<link href="css/media-player.css" rel="stylesheet">-->

    <!--<link rel="stylesheet" href="css/alert.css">-->
    <link rel="stylesheet" href="css/diary.css">
</head>
<body id="skin-blur-ocean">

<header id="header" class="media">
    <a href="" id="menu-toggle"></a>
    <a class="logo pull-left" href="index.html">云预警平台</a>

    <div class="media-body">
        <div class="media" id="top-menu">

            <!--//显示时间-->
            <div id="time" class="pull-right">
                <span id="hours"></span>
                :
                <span id="min"></span>
                :
                <span id="sec"></span>
            </div>
            <a href="alert.html" class="pull-right icon alert-tip animated" >
                <i id="alert_count" class="n-count animated"></i>
                &#61710;
            </a>
            <span class="pull-right" id="loginOut">退出</span>
            <span  class="pull-right"  id="username" >
                未登录
                <!--<img id="userimg" src="img/beauty.jpg" alt="">-->
                <!--<div class="userInfo">-->
                <!--<div class="nameinfo">-->
                <!--卜建立-->
                <!--</div>-->
                <!--<div class="infoBottom">-->
                <!--<span > [退出] </span>-->
                <!--</div>-->
                <!--</div>-->
            </span>
        </div>
    </div>
</header>


<div class="lds-spinner hidden"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>

<!--<div class="clearfix"></div>-->
<a href="#header" id="goTop" class="">
    <div class="goTop" ><i class="goTopIcon"></i></div>
</a>
<section id="main" class="p-relative" role="main">
    <!-- Sidebar -->
    <aside id="sidebar">

        <!-- Side Menu -->
        <ul class="list-unstyled side-menu">
            <li class="">
                <a class="sa-side-home" href="index.html">
                    <span class="menu-item">基本信息</span>
                </a>
            </li>

            <li class="active">
                <a class="sa-side-calendar" href="diary.html">
                    <span class="menu-item">历史查询</span>
                </a>
            </li>
            <li>
                <a class="sa-side-table" href="alert.html">
                    <span class="menu-item">正在警报</span>
                </a>
            </li>
        </ul>

    </aside>

    <!-- Content -->
    <section id="content" class="container"  >
        <h4 class="page-title">日志</h4>

        <form action="javascript:;" method="post">
            <div class="listview-header">
                <span class="search-number">
                    <span>
                        设备名：
                    </span>
                    <select name="p.p_name" id="search-select"  data-first-option="false" title='请选择' ></select>
                </span>
                <span class="search-begin">
                    <span>
                        开始时间：
                    </span>
                   <input type="text" name="md.dt_from_time" id="beginDate" class=""  autocomplete="off" placeholder="请选择开始时间" >
                </span>
                <span class="search-end">
                    <span>
                        结束时间：
                    </span>
                    <input type="text" name="md.dt_to_time" id="endDate" class=""  autocomplete="off" placeholder="请选择结束时间" >
                </span>
                <span class="">
                    <span>
                        警报状态：
                    </span>
                     <select name="md.dt_alert_level" id="attitude" class="selectpicker"  data-first-option="false" title='请选择' >
                          <option value="" style="text-align: center;border-bottom: 1px dotted #999;
                          border-right:15px dotted transparent; border-left:15px dotted transparent; ">请选择</option>
                          <option value="一级">一级</option>
                          <option value="二级">二级</option>
                          <option value="三级">三级</option>
                     </select>
                </span>
                <span>
                    <button id="reset" class="btn " type="submit" value=""><span class="glyphicon glyphicon-refresh"></span></button>
                    <button id="search-submit" class="btn " type="submit" value=""><span class="glyphicon glyphicon-search"></span></button>
                </span>
            </div>
        </form>

        <div id="search-table" class="  drawer animated toggled">
            <div class="showSearch-box ">
                <table id="showSearch" class="table table-hover" ></table>
            </div>
        </div>

        <div class="row searchMore">
            <div class="col-md-5">
                <div class="diary-video hidden tile animated  fadeInLeft ">
                    <video id='my-video' class='vjs-big-play-centered video-js'
                           style="width: 100%; height: 100%;">
                        <p class='vjs-no-js'>
                            To view this video please enable JavaScript, and consider upgrading to a web browser that
                            <a href='https://videojs.com/html5-video-support/' target='_blank'>supports HTML5 video</a>
                        </p>
                    </video>
                </div>
            </div>
            <div class="col-md-7">
                <div class="tile">
                    <div id="dayDiary" class="hidden animated fadeInRight " ></div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="tile">
                <div id="container" class="fadeInDownBig " ></div>
            </div>
        </div>
    </section>
</section>



<!-- Javascript Libraries -->
<!-- jQuery -->
<script src="js/jquery.min.js"></script> <!-- jQuery Library -->
<script src="js/jquery-ui.min.js"></script> <!-- jQuery UI -->
<!--<script src="js/jquery.easing.1.3.js"></script> &lt;!&ndash; jQuery Easing - Requirred for Lightbox + Pie Charts&ndash;&gt;-->
<!-- Bootstrap -->
<script src="js/bootstrap.min.js"></script>
<!-- UX -->
<!-- Other -->
<script src="js/feeds.min.js"></script> <!-- News Feeds -->
<!-- All JS functions -->
<script src="js/functions.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://unpkg.com/bootstrap-table@1.14.2/dist/bootstrap-table.min.js"></script>
<!-- Latest compiled and minified Locales -->
<script src="https://unpkg.com/bootstrap-table@1.14.2/dist/locale/bootstrap-table-zh-CN.min.js"></script>
<!--video.js-->
<script src="js/video.min.js"></script>
<!--bootstrap-select-->
<script src="js/bootstrap-select.js" type="text/javascript" charset="utf-8"></script>
<!--laydate-->
<script src="laydate/laydate.js"></script>
<!--cookie-->
<script src="js/jquery.cookie.js"></script>
<!--<script src="js/media-player.min.js"></script> &lt;!&ndash; Video Player &ndash;&gt;-->
<!--hightcharts-->
<script src="https://img.highcharts.com.cn/highstock/highstock.js"> </script>
<script src="https://img.highcharts.com.cn/highcharts/highcharts-more.js"></script>
<script src="https://img.highcharts.com.cn/highcharts/modules/exporting.js"></script>
<script src="https://img.highcharts.com.cn/highcharts-plugins/highcharts-zh_CN.js"></script>
<script>

    $(document).ready(function(){
        if((typeof ($.cookie("adminName")) === 'undefined')||(typeof ($.cookie("adminId")) === 'undefined')){
            window.location.href  = "login.html";
        }
    });

    $(function(){

        //获取地点
        $.get("http://47.112.132.177/ai_monitor/usr/ac_plh_place" , function(res){
            var $select = $("#search-select");
            var html = "  <option value='' style='text-align: center;border-bottom: 1px dotted #999;\n" +
                "border-right:15px dotted transparent; border-left:15px dotted transparent;'>请选择</option>";
            res.data.forEach(function(a,b,c){
                // console.log(a.city);//索引对象
                // console.log(b);//索引
                // console.log(c)//数组对象v
                html +=  "<option  value='"+a.p_id+"'>"+a.p_name+"</option>";
                $select.html(html);
                $select.selectpicker('refresh');//必须加，刷新select
            });
        },'json');


        /**
         * 获取所有查询设备
         * @关键字
         */
        (function(){
            $("#search-submit").on("click" , function(){
                $.ajax({
                    type:'post',
                    url:'http://47.112.132.177/ai_monitor/usr/ac_search',
                    dataType:'json',
                    data:{'md.dt_from_time':$('#beginDate').val(),'p.p_name':$('#search-select').val(),
                        'md.dt_to_time':$('#endDate').val(),'md.dt_alert_level':$('#attitude').val()},
                    beforeSend: function(){
                        $(".lds-spinner").toggleClass("hidden");
                    },
                    success:function(res){
                        if(res.status ===200 ){
                            // 显示表格
                            $("#container,.diary-video,#dayDiary").addClass("hidden");

                            $("#search-table").addClass('show').removeClass('hidden');
                            //获取查询结果
                            result(res);

                        }else{
                            // $("#search-table,#container,.diary-video,#dayDiary").addClass("hidden");
                            Ewin.alert("未查询到结果！");
                        }
                    },
                    error:function(){
                        // $("#search-table,#container,.diary-video,#dayDiary").addClass("hidden");
                        Ewin.alert("查询条件有误！");
                    },
                    complete:function () {
                        $(".lds-spinner").toggleClass("hidden");
                    }
                });
            });
        })();


        /**
         * 重置按钮
         * @关键字
         */
        $("#reset").on("click" , function(){
            document.getElementById("search-select").options.selectedIndex = 0; //回到初始状态
            document.getElementById("attitude").options.selectedIndex = 0; //回到初始状态
            $("#search-select,#attitude").selectpicker('refresh');//对searchPayState这个下拉框进行重置刷新
            $("#beginDate,#endDate").val("");                       //清空时间

        });


        /**
         * 获取设备详细信息
         * @关键字
         */
        var result = function(res){

                //为每个查询结果绑定点击事件
                window.operateEvents = {
                    'click span[class ^= "view"]': function (e, value, row, index) {
                        $("tr[data-index = "+index+"]").css("backgroundColor" , "rgba(0,0,0,0.7)").siblings().css("backgroundColor" , "");
                        $("#container,.diary-video,#dayDiary").removeClass("hidden");

                        $.ajax({
                            dataType:'json',
                            url:'http://47.112.132.177/ai_monitor/usr/ac_detail',
                            type:'post',
                            data:{"p.p_name":row.dt_place,"md.dt_preset_pn":row.dt_preset_n,"md.dt_alert_level":row.dt_alert_lev,
                                "md.dt_ppnb":row.dt_people_n,"md.dt_from_time":row.dt_year,"u.t_during":row.dt_time},
                            success:function(res){
                                coundAll(res.dt_changing_n_txt);
                                video(res.dt_vd_url);
                                thirtyTimes(row.dt_place);
                            }
                        });


                        return false;
                    },
                };

                //bootstrap-table添加标签
                function operateFormatter(value, row, index) {
                    return [
                        '<span  class = "view'+index+' glyphicon glyphicon-search label-success" href="javascript:;" ></span>'
                    ].join('');
                }

                var data = [];
                for(var i = 0 ; i < res.data.length ; i++ ){
                    data.push(res.data[i]);
                }
                //销毁原来的table
                $("#showSearch").bootstrapTable('destroy');
                //渲染table
                $('#showSearch').bootstrapTable({
                    data: data,//数据源
                    height:"200",
                    search: false,//是否搜索
                    pagination: false,//是否分页
                    pageSize: 5,//单页记录数
                    striped: true,//显示隔行间色
                    sidePagination: "client",//服务端分页
                    queryParamsType: "limit",//查询参数组织方式
                    responseHandler:function(res){      //初始化数据格式

                    },
                    queryParams: function getParams(params) {
                        params.other = "otherInfo";
                        return params;
                    },
                    searchOnEnterKey: false,//回车搜索
                    showRefresh: false,//刷新按钮
                    showColumns: false,//列选择按钮
                    buttonsAlign: "right",//按钮对齐方式
                    // toolbar: "",//指定工具栏
                    toolbarAlign: "",//工具栏对齐方式
                    columns: [
                        {
                            title: "设备",
                            field: "dt_place",
                            // titleTooltip: "this is name"
                            align: "center",//水平
                        },
                        {
                            field: "dt_preset_n",
                            title: "阈值",
                            align: "center",//水平
                        },
                        {
                            field: "dt_alert_lev",
                            title: "警报状态",
                            sortable: true,//是否可排序
                            align: "center",//水平
                        },
                        {
                            field: "dt_people_n",
                            title: "最高峰值",
                            sortable: true,//是否可排序
                            align: "center",//水平
                        },
                        {
                            field: "dt_workers",
                            title: "处理人员",
                            align: "center",//水平
                        },
                        {
                            field: "dt_year",
                            title: "日期",
                            sortable: true,//是否可排序
                            align: "center",//水平
                        },
                        {
                            field: "dt_time",
                            title: "爆发时间段",
                            align: "center",//水平
                        },
                        {
                            field: "",
                            title: "操作",
                            align: "center",//水平
                            events:operateEvents,
                            formatter: operateFormatter
                        },
                    ],

                    onPostBody:function() {},
                    locale: "zh-CN", //中文支持
                    detailView: false, //是否显示详情折叠
                });
        };


        /**
         * 获取实时视频数据
         * @关键字
         */
        var video = function(res){
                var url = "http://47.112.132.177";
                url += res;

               // $("#my-video").attr("src" , url);
                var options = {
                    controlBar:{                              //设置是否显示该组件
                        currentTimeDisplay:true,
                        timeDivider:true,
                        durationDisplay:false,
                        remainingTimeDisplay:true,//是否显示剩余时间
                        volumePanel: {
                            inline: false //默认是true,横着的
                        }
                    },
                    // autoplay: true,//自动播放
                    // muted:true,//静音
                    poster:"asd",//视频封面
                    controls:true,//是否显示组件
                    src:url,
                    notSupportedMessage:'本次告警时间太短,无视频生成！',
                };
                player = videojs('my-video', options , function(){
                    this.on('play',function(){
                            console.log('正在播放');
                        }
                    );

                    //暂停--播放完毕后也会暂停
                    this.on('pause',function(){
                        console.log("暂停中")
                    });

                    // 结束
                    this.on('ended', function() {
                        console.log('结束');
                    }),

                    this.load(url)
                });
                videojs("my-video").ready(function() {
                    var myPlayer = this;
                    myPlayer.src(url); /*动态设置video.js播放的地址。*/
                    // myPlayer.autoplay();
                });
        };


        /**
         * 人流变化图
         * @关键字
         */
        var coundAll = function(data){
                //<!--时间戳-->
                Highcharts.stockChart('dayDiary', {
                    colors:['rgb(255,117,153)'],
                    chart:{
                        backgroundColor:"",
                    },
                    rangeSelector: {
                        selected: 1,
                        enabled:false
                    },
                    title: {
                        text: '人流变化趋势',
                        style:{
                            color:'#FFD600',
                            fontSize:"15px",
                            fontFamily: 'open-sans-light'
                        },
                    },
                    xAxis: {
                        type: 'datetime',
                        dateTimeLabelFormats: {
                            // second: '%Y-%m-%d<br/>%H:%M:%S',
                            second: '%H:%M:%S',
                        },
                        labels: {                       //轴标签
                            style: {
                                color: "white",
                                fontFamily: 'open-sans-light'
                            }
                        }
                    },
                    yAxis:{
                        gridLineColor: 'rgba(0,0,0,1)',     //网格线颜色
                        labels: {                       //轴标签
                            style: {
                                color: "white",
                                fontFamily: 'open-sans-light'
                            }
                        }
                    },
                    navigator: {//下边导航栏
                        xAxis: {
                            labels: {
                                style: {
                                    color: 'white'
                                },
                            }
                        },
                        maskFill: 'rgba(180, 198, 220, 0.3)',//蒙版
                    },
                    credits:{
                        enabled:false
                    },
                    exporting:{
                        enabled:false
                    },
                    tooltip: {
                        split: false,
                        shared: true
                    },
                    plotOptions: {
                        series: {
                            showInLegend: true
                        }
                    },
                    series: [{
                        name: '人数',
                        data: data,
                    }],
                });

        };


        /**
         * 进三十日警报
         * @关键字
         */
        var thirtyTimes = function(place){
            var x,y;
            $.post("http://47.112.132.177/ai_monitor/usr/ac_gt_mst" , {"p.p_name":place} , function(data){
                data = JSON.parse(data);
                x = data.dt_x;
                y = data.dt_y;


                var chart = Highcharts.chart('container',{
                    colors:['#058DC7','#FF9655'],
                    chart: {
                        backgroundColor:"",
                        type: 'column'
                    },
                    title: {
                        text: '近三十次人流爆发峰值',
                        style:{
                            color:'#FFD600',
                            fontSize:"18px",
                            fontFamily: 'open-sans-light'
                        },
                    },
                    subtitle: {
                        text: ''
                    },
                    xAxis: {
                        categories: x,
                        crosshair: true,
                        labels: {                       //轴标签
                            style: {
                                color: "white",
                                fontFamily: 'open-sans-light'
                            }
                        },
                    },
                    yAxis: {
                        min: 0,
                        title: {
                            text: '人数',
                            style:{
                                color:'#FFD600',
                                fontSize:"15px",
                                fontFamily: 'open-sans-light'
                            },
                        },
                        labels: {                       //轴标签
                            style: {
                                color: "white",
                                fontFamily: 'open-sans-light'
                            }
                        }
                    },
                    credits:{
                        enabled:false,
                    },
                    exporting:{
                        enabled:false,
                    },
                    legend:{
                        enabled:false,
                    },
                    tooltip: {
                        // head + 每个 point + footer 拼接成完整的 table
                        headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                        pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                            '<td style="padding:0"><b>{point.y:.0f}人</b></td></tr>',
                        footerFormat: '</table>',
                        shared: true,
                        useHTML: true
                    },
                    plotOptions: {
                        column: {
                            borderWidth: 0
                        }
                    },
                    series: [{
                        name: ''+place+'',
                        colorByPoint: true,
                        data: y,
                    }]
                });
            });

        };

        
        /**
         * 日期选择
         * @关键字
         */
        (function(){
            var date = new Date();
            var Y = date.getFullYear();
            var M = date.getMonth()+1;
            var D = date.getDate()+1;
            //执行一个laydate实例
            var limitDate = ""+Y+"-"+M+"-"+D+"";
            laydate.render({
                elem:"#beginDate", //指定元素
                type:'datetime',
                theme:"blue",
                min:"2019-1-1",
                max:""+Y+"-"+M+"-"+D+"",
                show: false,
                btns:['clear', 'confirm'],//显示按钮
                change:function(date){
                    var day = "";
                    for(var i = 0 ; i < date.search(/\s/) ;i++ ){
                        day += date[i];
                    }
                    limitDate = day;
                    $("#endDate").remove();
                    $(".search-end").append("<input type=\"text\" name=\"md.dt_to_time\" id=\"endDate\" class=\"\"  autocomplete=\"off\" placeholder=\"请选择日期\" >")
                    laydate.render({
                        elem:"#endDate", //指定元素
                        type:'datetime',
                        theme:"blue",
                        min:limitDate,
                        max:""+Y+"-"+M+"-"+D+"",
                        show: false,
                        btns:['clear', 'confirm'],//显示按钮
                    });
                    console.log(day)
                },
            });
            laydate.render({
                elem:"#endDate", //指定元素
                type:'datetime',
                theme:"blue",
                min:"2019-1-1",
                max:limitDate,
                show: false,
                btns:['clear', 'confirm'],//显示按钮
            });
        })();


    });

</script>
</body>
</html>

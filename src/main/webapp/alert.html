<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>智能人流监测系统</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="format-detection" content="telephone=no">
    <meta charset="UTF-8">

    <meta name="description" content="Violate Responsive Admin Template">
    <meta name="keywords" content="Super Admin, Admin, Template, Bootstrap">

    <title>云检测平台</title>

    <!-- CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-editable.css" rel="stylesheet"/>
    <link rel="stylesheet" href="css/bootstrap-table.min.css">
    <link href="css/animate.min.css" rel="stylesheet">
    <link href="css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/form.css">
    <link href="css/style.css" rel="stylesheet">
    <link href="css/icons.css" rel="stylesheet">
    <link href="css/generics.css" rel="stylesheet">

    <link rel="stylesheet" href="css/alert.css">
    <link rel="stylesheet" href="css/diary.css">
<body id="skin-blur-ocean">

<header id="header" class="media">
    <a href="" id="menu-toggle"></a>
    <a class="logo pull-left" href="index.html">云预警平台</a>

    <div class="media-body">
        <div class="media" id="top-menu">

            <!--//显示时间-->
            <div id="time" class="pull-right">
                <span id="hours"></span>
                :
                <span id="min"></span>
                :
                <span id="sec"></span>
            </div>
            <span class="pull-right" id="loginOut">退出</span>
            <span  class="pull-right"  id="username" >
                未登录
                <!--<img id="userimg" src="img/beauty.jpg" alt="">-->
                <!--<div class="userInfo">-->
                <!--<div class="nameinfo">-->
                <!--卜建立-->
                <!--</div>-->
                <!--<div class="infoBottom">-->
                <!--<span > [退出] </span>-->
                <!--</div>-->
                <!--</div>-->
            </span>
        </div>
    </div>
</header>

<a href="#header" id="goTop" class="">
    <div class="goTop" ><i class="goTopIcon"></i></div>
</a>
<section id="main" class="p-relative" role="main">

    <!-- Sidebar -->
    <aside id="sidebar">

        <!-- Side Menu -->
        <ul class="list-unstyled side-menu">
            <li class="">
                <a class="sa-side-home" href="index.html">
                    <span class="menu-item">基本信息</span>
                </a>
            </li>

            <li>
                <a class="sa-side-calendar" href="diary.html">
                    <span class="menu-item">历史查询</span>
                </a>
            </li>
            <li class="active">
                <a class="sa-side-table" href="alert.html">
                    <span class="menu-item">正在警报</span>
                </a>
            </li>
        </ul>

    </aside>

    <!-- Content -->
    <section id="content" class="container">

            <div  class="headspace " style="padding: 23px 0;"></div>
            <div class="col-md-8  content-center">
                <div class="row center-middle tile">
                    <canvas id="video" style="width: 100%; height:100%"></canvas>
                </div>
                <div class="row center-bottom ">
                    <div id="" class="alert-secu-box ">
                        <table id="arranged" class="table table-hover" ></table>
                    </div>
                </div>
            </div>
            <!--右-->
            <div class="col-md-4  content-right">
                <div class="row right-top tile">
                    <div class="row">
                        <div class="col-xs-3 col-sm-3 col-md-3 text-center ">
                            <h4 class="page-title ">设备<span style="opacity: 0">空</span></h4>
                            <div id="alert_place" class="showNum">
                                 1
                            </div>
                        </div>
                        <div class="col-xs-3 col-sm-3 col-md-3  text-center ">
                            <h4 class="page-title ">人流数</h4>
                            <div id="num" class="showNum">
                                                        1
                            </div>
                        </div>
                        <div class="col-xs-3 col-sm-3 col-md-3  text-center">
                            <h4  class="page-title ">最高峰</h4>
                            <div id="max_num" class="showNum">
1
                            </div>
                        </div>
                        <div class="col-xs-3 col-sm-3 col-md-3 text-center set-numBox">
                            <h4 class="page-title ">阈值<span style="opacity: 0">空</span></h4>
                            <div id="set_num" class="showNum" >
1
                            </div>
                            <span class="glyphicon glyphicon-pencil changeLabel " data-toggle="modal" data-target="#myModal">可修改</span>
                        </div>
                    </div>
                    <p class="newNum " ></p>
                </div>
                <div class="row right-middle tile">
                    <img id="get_img" src="" alt="">
                </div>
                <div class="row right-bottom tile">
                    <div id="lineChart"></div>
                </div>
            </div>

    </section>

</section>

<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">请输入你要修改的值</h4>
            </div>
            <div class="modal-body myModal-body">
                <input type="text" id="newValue" class="form-control input-sm" style="padding-right: 24px;">
                <div class="input-error   hidden" >输入有误！</div>
                <div class="input-empty   hidden" >你尚未输入！</div>
            </div>
            <div class="modal-footer" style="margin-top: 0">
                <button type="button" id="closeBtn" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" id="send" class="btn btn-primary" >保存</button>
            </div>
        </div>
    </div>
</div>

<!-- jQuery -->
<script src="js/jquery.min.js"></script> <!-- jQuery Library -->
<script src="js/jquery-ui.min.js"></script> <!-- jQuery UI -->
<!-- Bootstrap -->
<script src="js/bootstrap.min.js"></script>
<!--cookie-->
<script src="js/jquery.cookie.js"></script>
<!-- Other -->
<script src="js/feeds.min.js"></script> <!-- News Feeds -->
<!-- All JS functions -->
<script src="js/functions.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="js/bootstrap-table.js"></script>
<!-- Latest compiled and minified Locales -->
<script src="https://unpkg.com/bootstrap-table@1.14.2/dist/locale/bootstrap-table-zh-CN.min.js"></script>
<!--video.js-->
<script src="js/video.min.js"></script>
<!--jsmpeg-->
<script src="jsmpeg/jsmpeg.min.js"></script>
<!--hightcharts-->
<script src="https://img.highcharts.com.cn/highstock/highstock.js"> </script>
<script src="https://img.highcharts.com.cn/highcharts/highcharts-more.js"></script>
<script src="https://img.highcharts.com.cn/highcharts/modules/exporting.js"></script>
<script src="https://img.highcharts.com.cn/highcharts-plugins/highcharts-zh_CN.js"></script>

<script>

    $(document).ready(function(){
        if((typeof ($.cookie("adminName")) === 'undefined')||(typeof ($.cookie("adminId")) === 'undefined')){
            window.location.href  = "login.html";
        }
    });

    $(function(){

        var x,y;//折线点
        var video_url;

        /**
         * 人员安排
         *@关键字
         */
        var security_table = function(){

            var w_id ;

            window.operateEvents = {
                'click a[class ^= "security-state"]': function  (e, value, row,index) {
                    Ewin.confirm({ message: "确定安排？" }).on(function (e) {
                        if (!e) {
                            return;
                        }
                        var $arrange = $(".security-state-"+index+"");

                        $.post("http://47.112.132.177/ai_monitor/admin/mc_st_sglewk" , {"u.id":w_id , "md.dt_id":$.cookie("img_id")} , function(res){
                            res = JSON.parse(res);
                            if(res.status === 400){
                                Ewin.alert("无法操作！");
                            }else if(res.status === 200){
                                $arrange.addClass("label-danger").removeClass("label-success").html("繁忙中");
                                Ewin.alert("操作成功！");
                            }
                        });
                    });
                }
            };
            function operateFormatter(value, row, index) {

                return [
                    '<a  class = "security-state-'+index+'   label-success "  href="javascript:void(0)">可安排</a>',
                ].join('');
            }
            $('#arranged').bootstrapTable({
                method:"post",
                url: "http://47.112.132.177/ai_monitor/usr/ac_worker_info",//数据源
                contentType:'application/x-www-form-urlencoded; charset=UTF-8',//请求数据内容格式 默认是 application/json 自己根据格式自行服务端处理
                dataType: "json",//期待返回数据类型
                dataField: "rows",//服务端返回数据键值 就是说记录放的键值是rows，分页时使用总记录数的键值为total
                height:"187",
                search: false,//是否搜索
                pagination: false,//是否分页
                pageSize: 5,//单页记录数
                striped: true,//显示隔行间色
                pageList: [ 10, 20, 50],//分页步进值
                sidePagination: "client",//服务端分页
                queryParamsType: "limit",//查询参数组织方式
                responseHandler:function(res){      //初始化数据格式
                    res = res.worker_data;
                    return res
                },
                queryParams:function(params){
                    return {"p.p_name":$.cookie("alert_place")};
                },
                searchOnEnterKey: false,//回车搜索
                showRefresh: false,//刷新按钮
                showColumns: false,//列选择按钮
                buttonsAlign: "right",//按钮对齐方式
                // toolbar: "",//指定工具栏
                toolbarAlign: "",//工具栏对齐方式
                columns: [
                    {
                        title: "ID",
                        field: "w_id",
                        visible:false,
                        // titleTooltip: "this is name"
                        align: "center",//水平
                        formatter:function(value,row,index){
                            return  "<div class='worker"+value+"'>"+value+" </div>"
                        },
                    },
                    {
                        title: "姓名",
                        field: "w_name",
                        // titleTooltip: "this is name"
                        align: "center",//水平
                    },
                    {
                        field: "w_contact",
                        title: "联系方式",
                        align: "center",//水平
                    },
                    {
                        field: "w_place",
                        title: "负责区域",
                        align: "center",//水平
                    },
                    {
                        field: "状态",
                        title: "状态",
                        align: "center",//水平
                        events:operateEvents ,
                        formatter: operateFormatter
                    }
                ],
                onClickRow:function(row,$element){
                    console.log(row);
                    w_id = row.w_id;
                },
                locale: "zh-CN", //中文支持
                detailView: false, //是否显示详情折叠
            });
        };
        security_table();


        /**
         * 折线图
         * @关键字
         */
        var lineChart = function(){
            var date = new Date();
            var year = date.getFullYear();
            var month = date.getMonth() + 1;
            var strDate = date.getDate();
            var today = year+"-"+month+"-"+strDate;
            //折线图
            function activeLastPointToolip(chart) {
                var points = chart.series[0].points;
                chart.tooltip.refresh(points[points.length -1]);
            }
            Highcharts.chart('lineChart', {
                colors: ['#7779a9'],
                chart: {
                    type: 'spline',
                    animation: Highcharts.svg, // don't animate in old IE
                    marginRight: 10,
                    height:335,
                    backgroundColor: "",
                    events: {
                        load: function () {

                            var flag = 0;
                            // set up the updating of the chart each second
                            var series = this.series[0];
                            // console.log(series);

                            var websocket = null;
                            //判断当前浏览器是否支持WebSocket
                            if ('WebSocket' in window) {
                                websocket = new WebSocket("ws://47.112.132.177/ai_monitor/wb/update");
                            } else {
                                alert('当前浏览器 Not support websocket')
                            }
                            //连接发生错误的回调方法
                            websocket.onerror = function () {

                            };
                            //连接成功建立的回调方法
                            websocket.onopen = function () {
                                var jsonStr = JSON.stringify({id: 'client', place_id: $.cookie("alert_place")});
                                websocket.send(jsonStr);
                            };
                            //接收到消息的回调方法
                            websocket.onmessage = function (event) {
                                setMessageInnerHTML(JSON.parse(event.data));
                            };
                            //连接关闭的回调方法
                            websocket.onclose = function () {
                                Ewin.confirm({ message: "预警结束，点击前往跳转！",btnok:"主页" }).on(function (e) {
                                    if (!e) {
                                        $("body").removeClass("modal-open");		//移处overflow hidden
                                        return;
                                    }
                                    window.location.href = "index.html";
                                });
                            };
                            //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
                            window.onbeforeunload = function () {
                                closeWebSocket();
                            };
                            //将消息显示在网页上
                            function setMessageInnerHTML(innerHTML) {
                                if(innerHTML.status === 200){
                                    Ewin.alert(innerHTML.msg);
                                }
                                x = (new Date()).getTime(), // current time
                                    y = innerHTML.crt_point[0][1];
                                $("#num").html(y);
                                $("#max_num").html(innerHTML.max_number);
                                $("#set_num").html(innerHTML.set_number);
                                if ($("#alert_place") !== $.cookie("alert_place")){
                                    $("#alert_place").html($.cookie("alert_place"));
                                }
                                if(video_url !== $.cookie("video_source")){
                                    video_url = $.cookie("video_source");
                                    video(video_url);
                                }
                                series.addPoint([x, y], true, true);
                            }
                            //关闭WebSocket连接
                            function closeWebSocket() {
                                websocket.close();
                            }

                            /**
                             * 发送修改阈值
                             */
                            var $empty = $(".input-empty");
                            var $error = $(".input-error");
                            $("#send").on("click" , function(){
                                var $value = $("#newValue").val();
                                if($value === ""){
                                    $empty.removeClass("hidden");
                                }else if(isNaN($value)){
                                    $error.removeClass("hidden");
                                }else{
                                    var jsonStr = JSON.stringify({id: 'client' , place_id:$.cookie("alert_place") ,msg:{"reset_number":$value}}  );
                                    websocket.send(jsonStr);
                                    $(".newNum").html("地点阈值已修改！新设阈值<span>"+$value+"</span>将在该地点下次告警时生效!");
                                    $("#closeBtn").get(0).click();
                                }
                            });

                            $("#newValue").on("keyup",function(){
                                $empty.addClass("hidden");
                                $error.addClass("hidden");
                            });
                        }
                    }
                },
                time: {
                    useUTC: false
                },
                title: {
                    text: '人流变化趋势图',
                    style:{
                        color:'#FFD600',
                        fontSize:"15px",
                        fontFamily: 'open-sans-light'
                    }
                },
                //副标题
                subtitle:{

                    text:""+today+"",
                    style:{
                        color:'white',
                        fontFamily: 'open-sans-light'
                    }
                },
                xAxis: {
                    title: {
                        text: '时间',
                        style:{
                            color:"#ddb500",
                            fontFamily: 'open-sans-light'
                        },
                        rotation: 0,
                        // offset:0,       //偏移
                        // x:210,
                        // y:0,
                    },
                    type: 'datetime',
                    tickPixelInterval: 150,
                    lineColor:"rbga(0,0,0,.3)",     //轴线颜色
                    labels: {                       //轴标签
                        style: {
                            color: "white",
                            fontFamily: 'open-sans-light'
                        }
                    }
                },
                yAxis: {
                    title: {
                        text: '人数',
                        style:{
                            color:"#ddb500",
                            fontFamily: 'open-sans-light'
                        },

                    },
                    labels: {//轴标签
                        style: {
                            color: "white",
                            fontFamily: 'open-sans-light'

                        }
                    },
                    gridLineColor: 'rgba(0,0,0,1)',     //网格线颜色
                    // gridLineWidth: 4,                //网格线宽度
                    //x轴宽度
                    plotLines: [{
                        value: 0,
                        width: 2,
                        color: '#9a9a9a'
                    }],

                },
                credits:{
                    enabled:false
                },
                //数据提示框
                tooltip: {
                    headerFormat: '<b>{series.name}</b><br/>',
                    pointFormat: '{point.x:%Y-%m-%d %H:%M:%S}<br/>{point.y:.0f}'
                },
                legend: {//图例
                    enabled: false
                },
                exporting: {
                    enabled: false
                },
                series: [{
                    name: '人流量',
                    data: (function () {
                        // generate an array of random data
                        var data = []
                            ,
                            time = (new Date()).getTime(),
                            i;
                        for (i = -19; i <= 0; i += 1) {
                            data.push({
                                x: time + i * 1000,
                                y: Math.round(Math.random() * 100)
                            });
                        }
                        return data;
                    }())
                }]
            });
        };
        lineChart();


        /**
         *
         * 实时视频
         * @关键字
         */
        var video = function(url){
            // Setup the jsmpeg player
             url  = "ws://47.112.132.177:"+url+"/";
            var player = new JSMpeg.Player(url, {
                canvas: document.getElementById('video'),
                // decodeFirstFrame: true,
            });
            player.play();
            document.getElementById('video').addEventListener('click', function(){
                if (player.isPlaying) {
                    player.pause();
                }
                else {
                    player.play();
                }
            })
        };


        /**
         *
         * 获取图片
         *@关键字
         */
        (function(){
            $.ajax({
                type:'post',
                dataType:'json',
                url:'http://47.112.132.177/ai_monitor/usr/ac_gt_url',
                data:{'md.dt_id':$.cookie("img_id")},
                success:function(res){
                    var pic_url = "http://47.112.132.177/"+res.pic_url+"";
                    // console.log(pic_url);
                    $("#get_img").attr("src" , pic_url);
                },
                error:function(){

                }
            });
            setInterval(function(){
                $.ajax({
                    type:'post',
                    dataType:'json',
                    url:'http://47.112.132.177/ai_monitor/usr/ac_gt_url',
                    data:{'md.dt_id':$.cookie("img_id")},
                    success:function(res){
                        var pic_url = "http://47.112.132.177/"+res.pic_url+"";
                        // console.log(pic_url);
                        $("#get_img").attr("src" , pic_url);
                    },
                    error:function(){

                    }
                })
            },1000);
        })();

        /**
         *手机端布局
         * @关键字
         */
        (function(){
            var zoom_in = 1;//放大
            var zoom_out = 1;//缩小
            if($(window).width() < 992){
                $(".content-center").remove();
                $("#content").append("      " +
                    "   <div class=\"col-md-8  content-center\">\n" +
                    "                <div class=\"row center-middle tile\">\n" +
                    "                    <canvas id=\"video\" style=\"width: 100%; height:100%\"></canvas>\n" +
                    "                </div>\n" +
                    "                <div class=\"row center-bottom \">\n" +
                    "                    <div id=\"\" class=\"alert-secu-box tile\">\n" +
                    "                        <table id=\"arranged\" class=\"table table-hover\" ></table>\n" +
                    "                    </div>\n" +
                    "                </div>\n" +
                    "            </div>");
                //初始化
                security_table();
                video_url = $.cookie("video_source");
                video(video_url);
            }
            window.onresize = function(){
                if($(window).width() < 992){
                    if(zoom_out === 1){
                        $(".content-center").remove();
                        $("#content").append("" +
                            "       <div class=\"col-md-8  content-center\">\n" +
                            "                <div class=\"row center-middle  tile\">\n" +
                            "                    <canvas id=\"video\" style=\"width: 100%; height:100%\"></canvas>\n" +
                            "                </div>\n" +
                            "                <div class=\"row center-bottom \">\n" +
                            "                    <div id=\"\" class=\"alert-secu-box \">\n" +
                            "                        <table id=\"arranged\" class=\"table table-hover\" ></table>\n" +
                            "                    </div>\n" +
                            "                </div>\n" +
                            "            </div>");
                        //初始化
                        security_table();
                        video_url = $.cookie("video_source");
                        video(video_url);
                        zoom_out = 0;
                        zoom_in = 1;
                    }
                }else{
                    if(zoom_in === 1){
                        $(".content-right").remove();
                        $("#content").append("" +
                            "      <div class=\"col-md-4  content-right\">\n" +
                            "                <div class=\"row right-top tile\">\n" +
                            "                    <div class=\"row\">\n" +
                            "                        <div class=\"col-xs-3 col-sm-3 col-md-3 text-center \">\n" +
                            "                            <h4 class=\"page-title \">设备<span style=\"opacity: 0\">空</span></h4>\n" +
                            "                            <div id='alert_place' class=\"showNum\">\n" +
                            "                               1 \n" +
                            "                            </div>\n" +
                            "                        </div>\n" +
                            "                        <div class=\"col-xs-3 col-sm-3 col-md-3  text-center \">\n" +
                            "                            <h4 class=\"page-title \">人流数</h4>\n" +
                            "                            <div id=\"num\" class=\"showNum\">\n" +
                            "                               1 \n" +
                            "                            </div>\n" +
                            "                        </div>\n" +
                            "                        <div class=\"col-xs-3 col-sm-3 col-md-3  text-center\">\n" +
                            "                            <h4 class=\"page-title \">最高峰</h4>\n" +
                            "                            <div id='max_num' class=\"showNum\">\n" +
                            "                                1\n" +
                            "                            </div>\n" +
                            "                        </div>\n" +
                            "                        <div class=\"col-xs-3 col-sm-3 col-md-3 text-center\">\n" +
                            "                            <h4 class=\"page-title \">阈值<span style=\"opacity: 0\">空</span></h4>\n" +
                            "                            <div id='set_num' class=\"showNum\"  >\n" +
                            "                               1\n" +
                            "                            </div>\n" +
                             "                           <span class=\"glyphicon glyphicon-pencil changeLabel \" data-toggle=\"modal\" data-target=\"#myModal\">可修改</span>\n" +
                            "                        </div>\n" +
                            "                    </div>\n" +
                            "              <p class=\"newNum \" >地点阈值已修改！新设阈值<span>12</span>将在该地点下次告警时生效!</p>\n" +
                            "                </div>\n" +
                            "                <div class=\"row right-middle tile\">\n" +
                            "                    <img src=\"img/skin-night.jpg\" alt=\"\">\n" +
                            "                </div>\n" +
                            "                <div class=\"row right-bottom tile\">\n" +
                            "                    <div id=\"lineChart\"></div>\n" +
                            "                </div>\n" +
                            "            </div>");
                        lineChart();
                        zoom_in = 0;
                        zoom_out = 1;
                    }
                }
            };
        })();

    })

</script>
</body>
</html>
